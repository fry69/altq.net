---
- name: Deploy PDS host
  hosts: pds

  gather_facts: false

  vars:
    status_service_path: "/etc/systemd/system/{{ status_service_name }}.service"
    status_timer_path: "/etc/systemd/system/{{ status_timer_name }}.timer"
    status_generate_command: >-
      {{ status_script_path }} --pds-config {{ pds_env_path }} --output {{ status_output_path }}

  pre_tasks:
    - name: Ensure required directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ pds_directory }}"
        - "{{ pds_directory }}/caddy/etc/caddy"
        - "{{ pds_webroot }}"
        - "{{ status_script_path | dirname }}"
        - "{{ status_output_path | dirname }}"
      tags: [files]

  tasks:
    - name: Deploy Docker Compose definition
      ansible.builtin.copy:
        src: compose.yaml
        dest: "{{ pds_directory }}/compose.yaml"
        mode: "0644"
      notify: restart pds
      tags: [compose]

    - name: Deploy Caddy configuration
      ansible.builtin.copy:
        src: caddy/etc/Caddyfile
        dest: "{{ pds_directory }}/caddy/etc/caddy/Caddyfile"
        mode: "0644"
      notify: reload caddy
      tags: [caddy]

    - name: Deploy Caddy webroot assets
      ansible.builtin.copy:
        src: caddy/webroot/
        dest: "{{ pds_webroot }}/"
        mode: "0644"
      notify: reload caddy
      tags: [caddy]

    - name: Deploy status script
      ansible.builtin.copy:
        src: bin/generate-status.py
        dest: "{{ status_script_path }}"
        mode: "0755"
      tags: [status]

    - name: Install status service unit
      ansible.builtin.template:
        src: ansible/templates/status-report.service.j2
        dest: "{{ status_service_path }}"
        mode: "0644"
      notify: reload systemd
      tags: [status]

    - name: Install status timer unit
      ansible.builtin.template:
        src: ansible/templates/status-report.timer.j2
        dest: "{{ status_timer_path }}"
        mode: "0644"
      notify: reload systemd
      tags: [status]

    - name: Enable and start status timer
      ansible.builtin.systemd:
        name: "{{ status_timer_name }}.timer"
        enabled: true
        state: started
      tags: [status]

    - name: Run status generation immediately (optional)
      ansible.builtin.command: "{{ status_generate_command }}"
      when: status_run_once | default(false)
      changed_when: true
      tags: [status, run_once]

    - name: Restart PDS service (optional)
      ansible.builtin.systemd:
        name: "{{ pds_systemd_service }}"
        state: restarted
      when: pds_restart | default(false)
      tags: [pds]

  handlers:
    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: restart pds
      ansible.builtin.systemd:
        name: "{{ pds_systemd_service }}"
        state: restarted

    - name: reload caddy
      ansible.builtin.command:
        cmd: docker compose -f {{ pds_directory }}/compose.yaml exec -w /etc/caddy caddy caddy reload
      changed_when: true
